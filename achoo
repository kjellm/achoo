#!/usr/bin/env ruby

require 'achoo/hour_registration_form'
require 'achoo/last'
require 'date'
require 'mechanize'

def main
  load_rc

  $agent = WWW::Mechanize.new
  
  login
  print_welcome
  
  $date = date_chooser
  puts "Selected #{$date.strftime('%Y-%m-%d')}"

  form = Achoo::HourRegistrationForm.new($agent)
  
  project = project_chooser(form)
  #FIX select phase
  
  remark = get_remark

  hours = hours_chooser
  puts

  form.set_values({
                    :date    => $date,
                    :project => project,
                    :remark  => remark,
                    :hours   => hours,
                  })
  form.print_values
  #confirm
  #form.submit
end


def hours_chooser
  puts "Last log:"
  last = Achoo::Last.new
  print last.find_by_date($date).join("\n")
  puts
  puts "Hours:"
  print "> "
  return gets.chop
end


def get_remark
  puts "RCS logs for #$date:"

  today = $date.strftime('%Y-%m-%d')
  tomorrow = $date.next.strftime('%Y-%m-%d')

  RC[:vcs_dirs].each do |dir|
    Dir.glob("#{dir}/*/").each do |dir|
      puts "---------(#{dir})-------------"
      if File.exist?("#{dir}/.git")
        system "cd  #{dir}; git log --author=#{ENV['USER']} --oneline --after=#{today} --before=#{tomorrow}| cut -d ' ' -f 2-"
      end
    end
  end
  puts "----------------------------------"
  puts "Remark:"
  print "> "
  return gets.chop
end


def project_chooser(form)
  puts "Choose project: "
  form.list_recent_projects
  puts "     0 - Other"
  print "[FIX]> "
  answer = gets.chop
  case answer
  when ''
    # FIX
    return 1
  when '0'
    return all_projects_chooser(form)
  else
    return answer
  end
end


def all_projects_chooser(form)
  form.list_all_projects
  print "> "
  answer = gets.chop
end


def login
  $agent.cookie_jar.load("#{ENV['HOME']}/.achoo_cookies.yml")

  page = $agent.get(RC[:url])

  return if page.forms.empty?

  form = page.forms.first
  form.auth_user = RC[:user]
  form.auth_pw   = RC[:password]
  page = $agent.submit(form, form.buttons.first)

  $agent.cookie_jar.save_as("#{ENV['HOME']}/.achoo_cookies.yml")

  # FIX check login failure
  # "Username and/or password are incorrect. Please try again."
end


def load_rc
  rc_file = "#{ENV['HOME']}/.achoo"

  # FIX test
  if File.stat(rc_file).mode != 0100600
    warn "Insecure permissions on #{rc_file}"
    exit 1
  end

  load rc_file
end


def print_welcome
  puts "Welcome to Achoo!"
end

def date_chooser
  today = Date.today
  puts "Register hours for today? [Y/<date>]"
  print "> "
  answer = gets.chop
  date = case answer
         when 'y', 'Y', ''
           today
         else
           Date.parse(answer)
         end
  return date
end


main
