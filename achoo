#!/usr/bin/env ruby

require 'achoo/hour_registration_form'
require 'achoo/last'
require 'date'
require 'mechanize'

def main
  load_rc

  agent = WWW::Mechanize.new
  
  login(agent)
  print_welcome
  
  date = date_chooser

  form = Achoo::HourRegistrationForm.new(agent)
  
  project = project_chooser(form)
  #FIX select phase
  
  remark = get_remark(date)

  hours = hours_chooser(date)
  puts

  form.set_values({
    :date    => date,
    :project => project,
    :remark  => remark,
    :hours   => hours,
  })
  if confirm(form)
    puts "Submitting ..."
    form.submit
  else
    puts "Cancelled"
  end

  puts
end


def confirm(form)
  form.print_values
  answer = ask "Submit this? [Y/n]"
  answer.downcase!
  return answer == 'y'
end


def hours_chooser(date)
  puts "Last log:"
  last = Achoo::Last.new
  print last.find_by_date(date).join("\n")
  puts
  return ask "Hours:"
end


def get_remark(date)
  puts "RCS logs for #{date}:"

  today    = date.strftime('%Y-%m-%d')
  tomorrow = date.next.strftime('%Y-%m-%d')

  RC[:vcs_dirs].each do |dir|
    Dir.glob("#{dir}/*/").each do |dir|
      puts "---------(#{dir})-------------"
      if File.exist?("#{dir}/.git")
        system "cd  #{dir}; git log --author=#{ENV['USER']} --oneline --after=#{today} --before=#{tomorrow}| cut -d ' ' -f 2-"
      end
    end
  end
  puts "----------------------------------"
  ask 'Remark: '
end


def project_chooser(form)
  puts 'Recently used projects'
  form.list_recent_projects
  puts "     0 - Other"
  answer = ask "Choose project: "
  case answer
  when ''
    warn "TODO Not implementd"
    exit 1
  when '0'
    return all_projects_chooser(form)
  else
    return answer
  end
end


def all_projects_chooser(form)
  form.list_all_projects
  answer = ask ''
end


def login(agent)
  agent.cookie_jar.load("#{ENV['HOME']}/.achoo_cookies.yml")

  page = agent.get(RC[:url])

  return if page.forms.empty?

  puts "Logging in"

  form = page.forms.first
  form.auth_user = RC[:user]
  form.auth_pw   = RC[:password]
  page = agent.submit(form, form.buttons.first)

  agent.cookie_jar.save_as("#{ENV['HOME']}/.achoo_cookies.yml")

  # FIX check login failure
  #  - "Username and/or password are incorrect. Please try again."
  #  - page.forms.empty?
end


def load_rc
  rc_file = "#{ENV['HOME']}/.achoo"

  # FIX test
  if File.stat(rc_file).mode != 0100600
    warn "Insecure permissions on #{rc_file}"
    exit 1
  end

  load rc_file
end


def print_welcome
  puts "Welcome to Achoo!"
end

def date_chooser
  today = Date.today
  answer = ask "Register hours for today? [Y/<date>]"
  date = case answer
         when 'y', 'Y', ''
           today
         else
           Date.parse(answer)
         end
  puts "Selected #{date.strftime('%Y-%m-%d')}"
  return date
end

def ask(question)
  print bold("#{question}\n> ")
  answer = gets.chop
  unless $stdin.tty?
    puts answer
  end
  answer
end

def bold(text)
  "\e[1m#{text}\e[0m"
end

main
